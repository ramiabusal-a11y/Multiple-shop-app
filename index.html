<!DOCTYPE html>
<!-- 
  ØªØµØ±Ù‘Ù ÙƒÙ…Ù‡Ù†Ø¯Ø³ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª Ø®Ø¨ÙŠØ± (Full-Stack Senior Engineer)
  Ù‡Ø°Ø§ Ù…Ù„Ù HTML ÙˆØ§Ø­Ø¯ ÙŠÙ…Ø«Ù„ ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªÙƒØ§Ù…Ù„. (Ù†Ø³Ø®Ø© Ù…ÙØµØ­Ø­Ø© v1.1)
  ÙŠØ³ØªØ®Ø¯Ù… TailwindCSSØŒ SupabaseØŒ CloudinaryØŒ Ùˆ OpenRouter.
-->
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-M">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªÙƒØ§Ù…Ù„</title>

    <!-- 1. ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Supabase Ùˆ Cloudinary Ùˆ Lucide Icons -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Tailwind Ø§Ù„Ù…Ø®ØµØµØ© + Ø®Ø·ÙˆØ· + Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <style type="text/tailwindcss">
        @layer base {
            /* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ø«Ù„Ø§Ø« */
            html {
                font-family: 'Inter', 'Cairo', 'Rubik', sans-serif;
            }
            /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø¨Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-thumb {
                @apply bg-gray-400 dark:bg-gray-600 rounded-full;
            }
            ::-webkit-scrollbar-track {
                @apply bg-transparent;
            }
        }
        @layer components {
            /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
            .btn-primary {
                @apply bg-primary-600 text-white hover:bg-primary-700 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200 disabled:opacity-50;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200 disabled:opacity-50;
            }
            .btn-danger {
                @apply bg-red-600 text-white hover:bg-red-700 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200 disabled:opacity-50;
            }
            
            /* Ø£Ù†Ù…Ø§Ø· Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
            .input-field {
                @apply bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500;
            }

            /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ */
            .product-card {
                @apply bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl;
            }

            /* Modal (Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©) */
            .modal-backdrop {
                @apply fixed inset-0 z-40 bg-black bg-opacity-50 backdrop-blur-sm transition-opacity;
            }
            .modal-content {
                @apply fixed inset-0 z-50 flex items-center justify-center p-4;
            }
            .modal-box {
                @apply bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto p-6;
            }
        }
    </style>
    
    <style>
        /* ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø«ÙŠÙ…Ø§Øª */
        :root {
            --color-primary-50: 239, 246, 255;  /* blue-50 */
            --color-primary-100: 219, 234, 254; /* blue-100 */
            --color-primary-200: 191, 219, 254; /* blue-200 */
            --color-primary-300: 147, 197, 253; /* blue-300 */
            --color-primary-400: 96, 165, 250;  /* blue-400 */
            --color-primary-500: 59, 130, 246;  /* blue-500 */
            --color-primary-600: 37, 99, 235;   /* blue-600 */
            --color-primary-700: 29, 78, 216;   /* blue-700 */
            --color-primary-800: 30, 64, 175;   /* blue-800 */
            --color-primary-900: 30, 58, 138;   /* blue-900 */
        }
        .theme-light-blue {
            --color-primary-50: 236, 254, 255;  /* cyan-50 */
            --color-primary-100: 207, 250, 254; /* cyan-100 */
            --color-primary-200: 165, 242, 252; /* cyan-200 */
            --color-primary-300: 103, 232, 249; /* cyan-300 */
            --color-primary-400: 34, 211, 238;  /* cyan-400 */
            --color-primary-500: 6, 182, 212;   /* cyan-500 */
            --color-primary-600: 8, 145, 178;   /* cyan-600 */
            --color-primary-700: 14, 116, 144;  /* cyan-700 */
            --color-primary-800: 21, 94, 117;   /* cyan-800 */
            --color-primary-900: 23, 78, 99;    /* cyan-900 */
        }
        .theme-yellow {
            --color-primary-50: 254, 252, 232;  /* yellow-50 */
            --color-primary-100: 254, 249, 195; /* yellow-100 */
            --color-primary-200: 254, 240, 138; /* yellow-200 */
            --color-primary-300: 253, 224, 71;  /* yellow-300 */
            --color-primary-400: 250, 204, 21;  /* yellow-400 */
            --color-primary-500: 234, 179, 8;   /* yellow-500 */
            --color-primary-600: 202, 138, 4;   /* yellow-600 */
            --color-primary-700: 161, 98, 7;    /* yellow-700 */
            --color-primary-800: 133, 77, 14;   /* yellow-800 */
            --color-primary-900: 113, 63, 18;   /* yellow-900 */
        }
        .theme-apple-green {
            --color-primary-50: 247, 254, 231;  /* lime-50 */
            --color-primary-100: 236, 252, 203; /* lime-100 */
            --color-primary-200: 217, 249, 157; /* lime-200 */
            --color-primary-300: 190, 242, 100; /* lime-300 */
            --color-primary-400: 163, 230, 53;  /* lime-400 */
            --color-primary-500: 132, 204, 22;  /* lime-500 */
            --color-primary-600: 101, 163, 13;  /* lime-600 */
            --color-primary-700: 77, 124, 15;   /* lime-700 */
            --color-primary-800: 63, 98, 18;    /* lime-800 */
            --color-primary-900: 54, 83, 20;    /* lime-900 */
        }
        .theme-dark-gold {
            --color-primary-50: 252, 251, 242;
            --color-primary-100: 248, 243, 220;
            --color-primary-200: 240, 230, 188;
            --color-primary-300: 230, 212, 148;
            --color-primary-400: 218, 189, 103;
            --color-primary-500: 202, 163, 71;  /* Gold */
            --color-primary-600: 181, 138, 59;
            --color-primary-700: 154, 110, 49;
            --color-primary-800: 131, 89, 42;
            --color-primary-900: 113, 73, 37;
        }

        /* ØªÙ…ÙƒÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ù†Ø§ ÙØ±Ø¶Ù‡ */
        :root {
            color-scheme: dark;
        }
        html.dark {
            color-scheme: dark;
        }
        body {
            /* Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù… */
            @apply bg-gray-900 text-gray-100;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <div id="app-root" class="min-h-screen">
        <!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
    </div>

    <!-- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù… -->
    <div id="whatsapp-button-container"></div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¨Ø¯ÙŠÙ„ Ù„Ù€ package.json) -->
    <script type="application/json" id="package-metadata">
    {
        "name": "single-file-ecommerce-app",
        "version": "1.1.0",
        "description": "Integrated E-commerce Store in a single HTML file (Bugfix release).",
        "author": "Full-Stack Senior Engineer (Gemini)",
        "dependencies": {
            "tailwindcss": "CDN",
            "@supabase/supabase-js": "CDN",
            "cloudinary-upload-widget": "CDN",
            "lucide": "CDN"
        }
    }
    </script>


    <!-- =================================================================== -->
    <!--             ğŸš€ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (JavaScript) ğŸš€              -->
    <!-- =================================================================== -->
    <script type="module">
        
        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª ---
        
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Supabase
        const { createClient } = supabase;
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ù…Ù„Ø§Ø¡ API (Ø³ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
        let supabaseClient = null;

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© (State Management) ---
        
        const AppState = {
            // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
            _state: {
                currentView: 'loading', // 'loading', 'login', 'store', 'admin', 'settings'
                user: null, // { id, email, role }
                products: [], // [ { id, name, description, price, stock, image_url } ]
                cart: [], // [ { productId, name, price, quantity } ]
                settings: {
                    lang: 'ar',
                    theme: 'theme-dark-blue', // Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    apiKeys: {
                        supabaseUrl: '',
                        supabaseKey: '',
                        cloudinaryCloudName: '',
                        cloudinaryUploadPreset: '',
                        openRouterKey: '',
                        whatsappNumber: '' // Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© e.g. 970xxxxxxxxx
                    }
                },
                isLoading: false,
                errorMessage: null,
                currentModal: null, // 'cart', 'editProduct', null
                productToEdit: null // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            },

            // Ù…Ø³ØªÙ…Ø¹ÙˆÙ† Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
            _listeners: new Set(),

            // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)
            get state() {
                return this._state;
            },

            // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (Ø³ØªÙ‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶)
            setState(newState) {
                // Ø¯Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                this._state = { ...this._state, ...newState };
                
                // Ø¥Ø®Ø·Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† (ÙÙŠ Ø­Ø§Ù„ØªÙ†Ø§ØŒ Ù‡Ùˆ Ù…Ø³ØªÙ…Ø¹ ÙˆØ§Ø­Ø¯: renderApp)
                this._listeners.forEach(listener => listener());
            },

            // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹
            addListener(listener) {
                this._listeners.add(listener);
            },

            // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹
            removeListener(listener) {
                this._listeners.delete(listener);
            }
        };

        // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø© (i18n) ---

        const translations = {
            ar: {
                appName: "Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„",
                loading: "ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„...",
                login: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
                signup: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
                logout: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
                email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
                password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
                loginSuccess: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!",
                signupSuccess: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.",
                errorOccurred: "Ø­Ø¯Ø« Ø®Ø·Ø£:",
                store: "Ø§Ù„Ù…ØªØ¬Ø±",
                adminDashboard: "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±",
                settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                back: "Ø±Ø¬ÙˆØ¹",
                save: "Ø­ÙØ¸",
                apiKeys: "Ù…ÙØ§ØªÙŠØ­ API",
                apiKeysWarning: "ØªÙØ­ÙØ¸ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø­Ù„ÙŠØ§Ù‹ (localStorage). Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ù…ÙØ§ØªÙŠØ­ Ø¥Ù†ØªØ§Ø¬ÙŠØ© ÙÙŠ Ø¨ÙŠØ¦Ø© ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚Ø©.",
                supabaseUrl: "Ø±Ø§Ø¨Ø· Supabase URL",
                supabaseKey: "Ù…ÙØªØ§Ø­ Supabase Anon",
                cloudinaryCloudName: "Ø§Ø³Ù… Ø³Ø­Ø§Ø¨Ø© Cloudinary",
                cloudinaryUploadPreset: "Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ø³Ø¨Ù‚ (Preset)",
                openRouterKey: "Ù…ÙØªØ§Ø­ OpenRouter API",
                whatsappNumber: "Ø±Ù‚Ù… WhatsApp (Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©)",
                language: "Ø§Ù„Ù„ØºØ©",
                theme: "Ø§Ù„Ø«ÙŠÙ…",
                themeDarkBlue: "Ø£Ø²Ø±Ù‚ ØºØ§Ù…Ù‚",
                themeLightBlue: "Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­",
                themeYellow: "Ø£ØµÙØ±",
                themeAppleGreen: "Ø£Ø®Ø¶Ø± ØªÙØ§Ø­ÙŠ",
                themeDarkGold: "Ø°Ù‡Ø¨ÙŠ ØºØ§Ù…Ù‚",
                settingsSaved: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.",
                keysMissing: "Ù…ÙØ§ØªÙŠØ­ Supabase Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.",
                welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹",
                myCart: "Ø³Ù„ØªÙŠ",
                products: "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
                price: "Ø§Ù„Ø³Ø¹Ø±",
                stock: "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
                addToCart: "Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©",
                checkout: "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡",
                total: "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
                emptyCart: "Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©.",
                admin: "Ø§Ù„Ù…Ø¯ÙŠØ±",
                viewStore: "Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¬Ø±",
                manageProducts: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
                aiTools: "Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ",
                addNewProduct: "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯",
                editProduct: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬",
                deleteProduct: "Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬",
                productName: "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬",
                productDescription: "ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬",
                productPrice: "Ø§Ù„Ø³Ø¹Ø±",
                productStock: "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
                productImage: "ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬",
                uploadImage: "Ø±ÙØ¹ ØµÙˆØ±Ø©",
                generateDescription: "Ø¥Ù†Ø´Ø§Ø¡ ÙˆØµÙ (AI)",
                generating: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...",
                deleteConfirm: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ",
                productAdded: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.",
                productUpdated: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.",
                productDeleted: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­.",
                contactSupport: "ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…",
                dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
                sh: "â‚ª" // Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© (Ù…Ø«Ø§Ù„: Ø´ÙŠÙƒÙ„)
            },
            en: {
                appName: "Integrated Store",
                loading: "Loading...",
                login: "Login",
                signup: "Sign Up",
                logout: "Logout",
                email: "Email",
                password: "Password",
                loginSuccess: "Logged in successfully!",
                signupSuccess: "Account created! Check your email for verification.",
                errorOccurred: "An error occurred:",
                store: "Store",
                adminDashboard: "Admin Dashboard",
                settings: "Settings",
                back: "Back",
                save: "Save",
                apiKeys: "API Keys",
                apiKeysWarning: "Keys are saved locally (localStorage). Do not use production keys in an untrusted environment.",
                supabaseUrl: "Supabase URL",
                supabaseKey: "Supabase Anon Key",
                cloudinaryCloudName: "Cloudinary Cloud Name",
                cloudinaryUploadPreset: "Cloudinary Upload Preset",
                openRouterKey: "OpenRouter API Key",
                whatsappNumber: "WhatsApp Number (with country code)",
                language: "Language",
                theme: "Theme",
                themeDarkBlue: "Dark Blue",
                themeLightBlue: "Light Blue",
                themeYellow: "Yellow",
                themeAppleGreen: "Apple Green",
                themeDarkGold: "Dark Gold",
                settingsSaved: "Settings saved.",
                keysMissing: "Supabase keys are required to start the app.",
                welcome: "Welcome",
                myCart: "My Cart",
                products: "Products",
                price: "Price",
                stock: "Stock",
                addToCart: "Add to Cart",
                checkout: "Checkout",
                total: "Total",
                emptyCart: "Your cart is empty.",
                admin: "Admin",
                viewStore: "View Store",
                manageProducts: "Manage Products",
                aiTools: "AI Tools",
                addNewProduct: "Add New Product",
                editProduct: "Edit Product",
                deleteProduct: "Delete Product",
                productName: "Product Name",
                productDescription: "Product Description",
                productPrice: "Price",
                productStock: "Stock",
                productImage: "Product Image",
                uploadImage: "Upload Image",
                generateDescription: "Generate Description (AI)",
                generating: "Generating...",
                deleteConfirm: "Are you sure you want to delete this product?",
                productAdded: "Product added successfully.",
                productUpdated: "Product updated successfully.",
                productDeleted: "Product deleted successfully.",
                contactSupport: "Contact Support",
                dashboard: "Dashboard",
                sh: "$" // Currency
            },
            he: {
                appName: "×—× ×•×ª ××©×•×œ×‘×ª",
                loading: "×˜×•×¢×Ÿ...",
                login: "×”×ª×—×‘×¨×•×ª",
                signup: "×”×¨×©××”",
                logout: "×”×ª× ×ª×§×•×ª",
                email: "××™××™×™×œ",
                password: "×¡×™×¡××”",
                loginSuccess: "×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×”!",
                signupSuccess: "×—×©×‘×•×Ÿ × ×•×¦×¨! ×‘×“×•×§ ××ª ×”××™××™×™×œ ×©×œ×š ×œ××™××•×ª.",
                errorOccurred: "××™×¨×¢×” ×©×’×™××”:",
                store: "×—× ×•×ª",
                adminDashboard: "×œ×•×— × ×™×”×•×œ",
                settings: "×”×’×“×¨×•×ª",
                back: "×—×–×•×¨",
                save: "×©××•×¨",
                apiKeys: "××¤×ª×—×•×ª API",
                apiKeysWarning: "××¤×ª×—×•×ª × ×©××¨×™× ××§×•××™×ª (localStorage). ××œ ×ª×©×ª××© ×‘××¤×ª×—×•×ª ×™×™×¦×•×¨ ×‘×¡×‘×™×‘×” ×œ× ××”×™×× ×”.",
                supabaseUrl: "Supabase URL",
                supabaseKey: "Supabase Anon Key",
                cloudinaryCloudName: "Cloudinary Cloud Name",
                cloudinaryUploadPreset: "Cloudinary Upload Preset",
                openRouterKey: "OpenRouter API Key",
                whatsappNumber: "××¡×¤×¨ WhatsApp (×¢× ×§×™×“×•××ª ××“×™× ×”)",
                language: "×©×¤×”",
                theme: "×¢×¨×›×ª × ×•×©×",
                themeDarkBlue: "×›×—×•×œ ×›×”×”",
                themeLightBlue: "×ª×›×œ×ª",
                themeYellow: "×¦×”×•×‘",
                themeAppleGreen: "×™×¨×•×§ ×ª×¤×•×—",
                themeDarkGold: "×–×”×‘ ×›×”×”",
                settingsSaved: "×”×”×’×“×¨×•×ª × ×©××¨×•.",
                keysMissing: "× ×“×¨×©×™× ××¤×ª×—×•×ª Supabase ×œ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”.",
                welcome: "×‘×¨×•×š ×”×‘×",
                myCart: "×”×¢×’×œ×” ×©×œ×™",
                products: "××•×¦×¨×™×",
                price: "××—×™×¨",
                stock: "××œ××™",
                addToCart: "×”×•×¡×£ ×œ×¢×’×œ×”",
                checkout: "×œ×ª×©×œ×•×",
                total: "×¡×š ×”×›×œ",
                emptyCart: "×”×¢×’×œ×” ×©×œ×š ×¨×™×§×”.",
                admin: "×× ×”×œ",
                viewStore: "×¦×¤×” ×‘×—× ×•×ª",
                manageProducts: "× ×”×œ ××•×¦×¨×™×",
                aiTools: "×›×œ×™ AI",
                addNewProduct: "×”×•×¡×£ ××•×¦×¨ ×—×“×©",
                editProduct: "×¢×¨×•×š ××•×¦×¨",
                deleteProduct: "××—×§ ××•×¦×¨",
                productName: "×©× ×”××•×¦×¨",
                productDescription: "×ª×™××•×¨ ×”××•×¦×¨",
                productPrice: "××—×™×¨",
                productStock: "××œ××™",
                productImage: "×ª××•× ×ª ××•×¦×¨",
                uploadImage: "×”×¢×œ×” ×ª××•× ×”",
                generateDescription: "×¦×•×¨ ×ª×™××•×¨ (AI)",
                generating: "×™×•×¦×¨...",
                deleteConfirm: "×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×¦×¨ ×–×”?",
                productAdded: "×”××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”.",
                productUpdated: "×”××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”.",
                productDeleted: "×”××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”.",
                contactSupport: "×¦×•×¨ ×§×©×¨ ×¢× ×”×ª××™×›×”",
                dashboard: "×œ×•×— ×‘×§×¨×”",
                sh: "â‚ª" // Currency
            }
        };

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ±Ø¬Ù…Ø©
        function t(key) {
            return translations[AppState.state.settings.lang][key] || key;
        }

        // --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø§Øª API ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª ---

        // 4.1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (localStorage)
        const SETTINGS_KEY = 'ecommerce_app_settings';

        function saveSettings() {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(AppState.state.settings));
                showToast(t('settingsSaved'), 'success');
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                initServices();
            } catch (error) {
                console.error("Error saving settings:", error);
                showToast(t('errorOccurred') + ` ${error.message}`, 'error');
            }
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem(SETTINGS_KEY);
                if (savedSettings) {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                    const defaultSettings = AppState.state.settings;
                    const mergedSettings = {
                        ...defaultSettings,
                        ...parsedSettings,
                        apiKeys: {
                            ...defaultSettings.apiKeys,
                            ...parsedSettings.apiKeys
                        }
                    };
                    AppState.setState({ settings: mergedSettings });
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                // Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª
            }
        }

        // 4.2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Supabase)
        function initServices() {
            const { supabaseUrl, supabaseKey } = AppState.state.settings.apiKeys;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            if (!supabaseUrl || !supabaseKey) {
                console.warn("Supabase keys are missing.");
                // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù„Ø³Ù†Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù†Ù‚Ù„Ù†Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                if (AppState.state.currentView !== 'settings' && AppState.state.currentView !== 'login') {
                    // Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ØŒ ÙÙ‚Ø· Ù‚Ù… Ø¨Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
                    AppState.setState({ currentView: 'settings' });
                }
                return false; // ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            }

            // ØªÙ‡ÙŠØ¦Ø© Supabase
            try {
                // (ØªØ­Ø³ÙŠÙ†) Ù„Ø§ ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ„Ù… ØªØªØºÙŠØ± Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                if (!supabaseClient || supabaseClient.supabaseUrl !== supabaseUrl || supabaseClient.supabaseKey !== supabaseKey) {
                    
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    
                    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                    supabaseClient.auth.onAuthStateChange((event, session) => {
                        handleAuthStateChange(session);
                    });
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                supabaseClient.auth.getSession().then(({ data }) => {
                    handleAuthStateChange(data.session);
                });

                return true; // Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
            } catch (error) {
                console.error("Error initializing Supabase:", error);
                // Ù‡Ø°Ø§ Ø®Ø·Ø£ Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ø«Ù„ Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± ØµØ§Ù„Ø­Ø©)
                AppState.setState({ errorMessage: t('errorOccurred') + ` ${error.message}` });
                return false;
            }
        }

        // 4.3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        async function handleAuthStateChange(session) {
            if (session) {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                const user = session.user;
                // Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (Roles) ØªÙØ®Ø²Ù† Ø¹Ø§Ø¯Ø© ÙÙŠ user_metadata
                // Ù†Ø­Ù† Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø¯ÙŠØ± (admin) Ù„Ø¯ÙŠÙ‡ role = 'admin' ÙÙŠ metadata
                const userRole = user.user_metadata?.role || 'shopper'; 
                
                AppState.setState({ 
                    user: { id: user.id, email: user.email, role: userRole },
                    currentView: userRole === 'admin' ? 'admin' : 'store',
                    isLoading: false,
                    errorMessage: null
                });
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ù‚Ù… Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                if (AppState.state.currentView === 'store' || AppState.state.currentView === 'admin') {
                    fetchProducts();
                }
            } else {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… (ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
                AppState.setState({ 
                    user: null, 
                    currentView: 'login', // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    products: [],
                    cart: [],
                    isLoading: false,
                    errorMessage: null
                });
            }
        }
        
        async function handleLogin(email, password) {
            if (!supabaseClient) return initServices();
            AppState.setState({ isLoading: true, errorMessage: null });
            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // onAuthStateChange Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
            } catch (error) {
                console.error("Login error:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        async function handleSignup(email, password) {
            if (!supabaseClient) return initServices();
            AppState.setState({ isLoading: true, errorMessage: null });
            try {
                const { error } = await supabaseClient.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙƒÙ€ "Ù…ØªØ³ÙˆÙ‚"
                        data: { 
                            role: 'shopper' 
                        }
                    }
                });
                if (error) throw error;
                showToast(t('signupSuccess'), 'success');
                AppState.setState({ isLoading: false, errorMessage: null });
            } catch (error) {
                console.error("Signup error:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        async function handleLogout() {
            if (!supabaseClient) return;
            AppState.setState({ isLoading: true });
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // onAuthStateChange Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
            } catch (error) {
                console.error("Logout error:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        // 4.4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Supabase DB)
        // (Ù†ÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ 'products' ÙÙŠ Supabase)
        async function fetchProducts() {
            if (!supabaseClient) return;
            AppState.setState({ isLoading: true });
            try {
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*');
                
                if (error) throw error;
                
                AppState.setState({ products: data || [], isLoading: false });
            } catch (error) {
                console.error("Error fetching products:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }
        
        async function addProduct(productData) {
            if (!supabaseClient) return;
            AppState.setState({ isLoading: true });
            try {
                const { error } = await supabaseClient
                    .from('products')
                    .insert([productData]); // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒØ§Ø¦Ù† Ø¯Ø§Ø®Ù„ Ù…ØµÙÙˆÙØ©
                
                if (error) throw error;
                
                showToast(t('productAdded'), 'success');
                AppState.setState({ isLoading: false, currentModal: null });
                fetchProducts(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            } catch (error) {
                console.error("Error adding product:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        async function updateProduct(productId, productData) {
            if (!supabaseClient) return;
            AppState.setState({ isLoading: true });
            try {
                const { error } = await supabaseClient
                    .from('products')
                    .update(productData)
                    .eq('id', productId);
                
                if (error) throw error;
                
                showToast(t('productUpdated'), 'success');
                AppState.setState({ isLoading: false, currentModal: null, productToEdit: null });
                fetchProducts(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            } catch (error) {
                console.error("Error updating product:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        async function deleteProduct(productId) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
            if (!window.confirm(t('deleteConfirm'))) return;

            if (!supabaseClient) return;
            AppState.setState({ isLoading: true });
            try {
                const { error } = await supabaseClient
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                showToast(t('productDeleted'), 'success');
                AppState.setState({ isLoading: false });
                fetchProducts(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            } catch (error) {
                console.error("Error deleting product:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
            }
        }

        // 4.5. Ø®Ø¯Ù…Ø© Cloudinary (Upload Widget)
        function openCloudinaryWidget(onSuccess) {
            const { cloudinaryCloudName, cloudinaryUploadPreset } = AppState.state.settings.apiKeys;
            
            if (!cloudinaryCloudName || !cloudinaryUploadPreset) {
                showToast(t('keysMissing'), 'error');
                AppState.setState({ currentView: 'settings' }); // Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ØŒ ÙÙ‚Ø· ÙˆØ¬Ù‡
                return;
            }

            const widget = window.cloudinary.createUploadWidget({
                cloudName: cloudinaryCloudName,
                uploadPreset: cloudinaryUploadPreset,
                cropping: true,
                multiple: false,
                folder: "ecommerce-store"
            }, (error, result) => {
                if (!error && result && result.event === "success") {
                    console.log('Cloudinary Success:', result.info);
                    onSuccess(result.info.secure_url); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙƒÙˆÙ„Ø¨Ø§Ùƒ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¢Ù…Ù†
                } else if (error) {
                    console.error("Cloudinary Error:", error);
                    showToast(t('errorOccurred') + ` ${error.message}`, 'error');
                }
            });
            
            widget.open(); // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±ÙØ¹
        }

        // 4.6. Ø®Ø¯Ù…Ø© OpenRouter (AI)
        async function generateAIProductDescription(productName) {
            const { openRouterKey } = AppState.state.settings.apiKeys;
            
            if (!openRouterKey) {
                showToast(t('keysMissing'), 'error');
                AppState.setState({ currentView: 'settings' }); // Ù„Ø§ ØªÙ‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ØŒ ÙÙ‚Ø· ÙˆØ¬Ù‡
                return null;
            }

            AppState.setState({ isLoading: true });
            
            const prompt = `Write a short, enticing, and professional e-commerce product description for: "${productName}". Focus on benefits and appeal. Maximum 3 sentences. Language: ${AppState.state.settings.lang}`;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${openRouterKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-3.5-turbo', // ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø£ÙŠ Ù…ÙˆØ¯ÙŠÙ„
                        messages: [
                            { role: 'system', content: 'You are an expert e-commerce copywriter.' },
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'OpenRouter API error');
                }
                
                const data = await response.json();
                const description = data.choices[0].message.content.trim();
                
                AppState.setState({ isLoading: false });
                return description;

            } catch (error) {
                console.error("OpenRouter Error:", error);
                AppState.setState({ isLoading: false, errorMessage: t('errorOccurred') + ` ${error.message}` });
                return null;
            }
        }
        
        // 4.7. Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Cart Logic)
        function addToCart(productId) {
            const { products, cart } = AppState.state;
            const product = products.find(p => p.id === productId);
            
            if (!product || product.stock <= 0) return; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù†ÙØ¯ Ù…Ø®Ø²ÙˆÙ†Ù‡
            
            const existingItemIndex = cart.findIndex(item => item.productId === productId);
            let newCart = [...cart];

            if (existingItemIndex > -1) {
                // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„
                newCart[existingItemIndex].quantity += 1;
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø³Ù„Ø©
                newCart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.image_url,
                    quantity: 1
                });
            }
            
            AppState.setState({ cart: newCart });
            showToast(`${product.name} ${t('addToCart')}`, 'success');
        }

        function removeFromCart(productId) {
             let newCart = AppState.state.cart.filter(item => item.productId !== productId);
             AppState.setState({ cart: newCart });
        }
        
        function updateCartQuantity(productId, quantity) {
            let newCart = [...AppState.state.cart];
            const itemIndex = newCart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                if (quantity <= 0) {
                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© 0 Ø£Ùˆ Ø£Ù‚Ù„
                    newCart.splice(itemIndex, 1);
                } else {
                    // (ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù‡Ù†Ø§)
                    newCart[itemIndex].quantity = quantity;
                }
                AppState.setState({ cart: newCart });
            }
        }


        // --- 5. Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ (Render Components) ---

        // 5.1. Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
        
        // Ù…ÙƒÙˆÙ† Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function renderLoading() {
            return `
                <div class="flex items-center justify-center min-h-screen">
                    <svg class="animate-spin h-10 w-10 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="ms-3 text-lg font-medium">${t('loading')}</span>
                </div>
            `;
        }
        
        // Ù…ÙƒÙˆÙ† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        function renderErrorMessage() {
            if (!AppState.state.errorMessage) return '';
            return `
                <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-900 dark:text-red-300" role="alert">
                    <span class="font-medium">${t('errorOccurred')}</span> ${AppState.state.errorMessage}
                </div>
            `;
        }

        // Ù…ÙƒÙˆÙ† Toast (Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©)
        function showToast(message, type = 'info') {
            const toastId = `toast-${Date.now()}`;
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-green-600',
                error: 'bg-red-600'
            };
            
            const toastElement = document.createElement('div');
            toastElement.id = toastId;
            toastElement.className = `fixed bottom-5 end-5 p-4 rounded-lg text-white shadow-lg z-[100] transition-all duration-300 translate-x-full ${colors[type]}`;
            toastElement.innerHTML = `<span>${message}</span>`;
            
            document.body.appendChild(toastElement);
            
            // Ø¥Ø¸Ù‡Ø§Ø±
            setTimeout(() => {
                toastElement.classList.remove('translate-x-full');
                toastElement.classList.add('translate-x-0');
            }, 100); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ­Ø±ÙŠÙƒ
            
            // Ø¥Ø®ÙØ§Ø¡
            setTimeout(() => {
                toastElement.classList.add('translate-x-full');
                toastElement.classList.remove('translate-x-0');
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
                setTimeout(() => {
                    toastElement.remove();
                }, 300);
            }, 3000); // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
        }

        // 5.2. Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        
        // --- ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login View) ---
        function renderLoginView() {
            return `
                <div class="flex flex-col items-center justify-center px-6 py-8 mx-auto min-h-screen lg:py-0">
                    <a href="#" class="flex items-center mb-6 text-2xl font-semibold text-gray-900 dark:text-white">
                        <i data-lucide="shopping-bag" class="w-8 h-8 me-2 text-primary-500"></i>
                        ${t('appName')}
                    </a>
                    <div class="w-full bg-white rounded-lg shadow dark:border md:mt-0 sm:max-w-md xl:p-0 dark:bg-gray-800 dark:border-gray-700">
                        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
                            <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white">
                                ${t('login')}
                            </h1>
                            ${renderErrorMessage()}
                            <form id="login-form" class="space-y-4 md:space-y-6">
                                <div>
                                    <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">${t('email')}</label>
                                    <input type="email" name="email" id="email" class="input-field" placeholder="name@company.com" required>
                                </div>
                                <div>
                                    <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">${t('password')}</label>
                                    <input type="password" name="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="input-field" required>
                                </div>
                                <div class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 rtl:sm:space-x-reverse">
                                    <button type="submit" data-action="login-submit" class="w-full btn-primary">
                                        ${AppState.state.isLoading ? t('loading') : t('login')}
                                    </button>
                                    <button type="button" data-action="signup-submit" class="w-full btn-secondary">
                                        ${AppState.state.isLoading ? t('loading') : t('signup')}
                                    </button>
                                </div>
                                <div class="text-center">
                                    <button type="button" data-action="go-to-settings" class="text-sm font-medium text-primary-500 hover:underline">
                                        ${t('settings')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Settings View) ---
        function renderSettingsView() {
            const { settings } = AppState.state;
            const keys = settings.apiKeys;
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Supabase Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
            const keysAreMissing = !keys.supabaseUrl || !keys.supabaseKey;

            return `
                <div class="flex flex-col items-center justify-center px-6 py-8 mx-auto min-h-screen lg:py-0">
                    <a href="#" class="flex items-center mb-6 text-2xl font-semibold text-gray-900 dark:text-white">
                        <i data-lucide="settings" class="w-8 h-8 me-2 text-primary-500"></i>
                        ${t('settings')}
                    </a>
                    <div class="w-full bg-white rounded-lg shadow dark:border md:mt-0 sm:max-w-2xl xl:p-0 dark:bg-gray-800 dark:border-gray-700">
                        <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
                            
                            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© (Ù…Ø«Ù„ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„) -->
                            ${renderErrorMessage()}

                            <!-- Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø±Ø´Ø§Ø¯ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…ÙÙ‚ÙˆØ¯Ø© (ÙˆÙ„ÙŠØ³ Ø®Ø·Ø£) -->
                            ${keysAreMissing && !AppState.state.errorMessage ? `
                                <div class="p-4 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg dark:bg-blue-900 dark:text-blue-300" role="alert">
                                    <span class="font-medium">${t('keysMissing')}</span>
                                </div>
                            ` : ''}

                            <form id="settings-form" class="space-y-4">
                                
                                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø«ÙŠÙ… -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="lang-select" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">${t('language')}</label>
                                        <select id="lang-select" name="lang" class="input-field">
                                            <option value="ar" ${settings.lang === 'ar' ? 'selected' : ''}>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
                                            <option value="en" ${settings.lang === 'en' ? 'selected' : ''}>English</option>
                                            <option value="he" ${settings.lang === 'he' ? 'selected' : ''}>×¢×‘×¨×™×ª (Hebrew)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="theme-select" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">${t('theme')}</label>
                                        <select id="theme-select" name="theme" class="input-field">
                                            <option value="theme-dark-blue" ${settings.theme === 'theme-dark-blue' ? 'selected' : ''}>${t('themeDarkBlue')}</option>
                                            <option value="theme-light-blue" ${settings.theme === 'theme-light-blue' ? 'selected' : ''}>${t('themeLightBlue')}</option>
                                            <option value="theme-yellow" ${settings.theme === 'theme-yellow' ? 'selected' : ''}>${t('themeYellow')}</option>
                                            <option value="theme-apple-green" ${settings.theme === 'theme-apple-green' ? 'selected' : ''}>${t('themeAppleGreen')}</option>
                                            <option value="theme-dark-gold" ${settings.theme === 'theme-dark-gold' ? 'selected' : ''}>${t('themeDarkGold')}</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Ù…ÙØ§ØªÙŠØ­ API -->
                                <h3 class="text-lg font-semibold dark:text-white">${t('apiKeys')}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${t('apiKeysWarning')}</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="md:col-span-2">
                                        <label for="supabaseUrl" class="block mb-2 text-sm font-medium">${t('supabaseUrl')}</label>
                                        <input type="text" name="supabaseUrl" id="supabaseUrl" class="input-field" value="${keys.supabaseUrl}" placeholder="https://xyz.supabase.co">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="supabaseKey" class="block mb-2 text-sm font-medium">${t('supabaseKey')}</label>
                                        <input type="password" name="supabaseKey" id="supabaseKey" class="input-field" value="${keys.supabaseKey}" placeholder="eyJ...">
                                    </div>
                                    <div>
                                        <label for="cloudinaryCloudName" class="block mb-2 text-sm font-medium">${t('cloudinaryCloudName')}</label>
                                        <input type="text" name="cloudinaryCloudName" id="cloudinaryCloudName" class="input-field" value="${keys.cloudinaryCloudName}" placeholder="your-cloud-name">
                                    </div>
                                    <div>
                                        <label for="cloudinaryUploadPreset" class="block mb-2 text-sm font-medium">${t('cloudinaryUploadPreset')}</label>
                                        <input type="text" name="cloudinaryUploadPreset" id="cloudinaryUploadPreset" class="input-field" value="${keys.cloudinaryUploadPreset}" placeholder="your-preset-name">
                                    </div>
                                    <div>
                                        <label for="openRouterKey" class="block mb-2 text-sm font-medium">${t('openRouterKey')}</label>
                                        <input type="password" name="openRouterKey" id="openRouterKey" class="input-field" value="${keys.openRouterKey}" placeholder="sk-or-...">
                                    </div>
                                    <div>
                                        <label for="whatsappNumber" class="block mb-2 text-sm font-medium">${t('whatsappNumber')}</label>
                                        <input type="text" name="whatsappNumber" id="whatsappNumber" class="input-field" value="${keys.whatsappNumber}" placeholder="97259xxxxxxx">
                                    </div>
                                </div>

                                <div class="flex space-x-3 rtl:space-x-reverse pt-4">
                                    <button type="submit" data-action="save-settings" class="btn-primary">
                                        ${t('save')}
                                    </button>
                                    <button type="button" data-action="back-from-settings" class="btn-secondary">
                                        ${t('back')}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø¹Ø§Ù… (Navbar) ---
        function renderNavbar() {
            const { user } = AppState.state;
            const isAdmin = user?.role === 'admin';
            
            return `
                <nav class="bg-white border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700 shadow-sm sticky top-0 z-30">
                    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
                        <a href="#" data-action="go-to-home" class="flex items-center space-x-3 rtl:space-x-reverse">
                            <i data-lucide="shopping-bag" class="h-8 w-8 text-primary-500"></i>
                            <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">${t('appName')}</span>
                        </a>
                        
                        <div class="flex items-center space-x-2 md:space-x-3 rtl:space-x-reverse">
                            <span class="text-sm text-gray-500 dark:text-gray-400 hidden sm:inline">${t('welcome')}, ${user?.email || 'Guest'}</span>
                            
                            <!-- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…/Ø§Ù„Ù…ØªØ¬Ø± -->
                            ${isAdmin ? `
                                <button type="button" data-action="${AppState.state.currentView === 'admin' ? 'go-to-store' : 'go-to-admin'}" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                                    ${AppState.state.currentView === 'admin' ? `
                                        <i data-lucide="store" class="w-5 h-5"></i>
                                        <span class="sr-only">${t('viewStore')}</span>
                                    ` : `
                                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                                        <span class="sr-only">${t('adminDashboard')}</span>
                                    `}
                                </button>
                            ` : ''}
                            
                            <!-- Ø²Ø± Ø§Ù„Ø³Ù„Ø© (Ù„Ù„Ù…ØªØ³ÙˆÙ‚ ÙÙ‚Ø·) -->
                            ${!isAdmin ? `
                                <button type="button" data-action="open-cart" class="relative p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                    <span class="sr-only">${t('myCart')}</span>
                                    ${AppState.state.cart.length > 0 ? `
                                        <span class="absolute -top-1 -end-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary-500 text-xs font-bold text-white">
                                            ${AppState.state.cart.reduce((sum, item) => sum + item.quantity, 0)}
                                        </span>
                                    ` : ''}
                                </button>
                            ` : ''}

                            <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                            <button type="button" data-action="go-to-settings" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                                <i data-lucide="settings" class="w-5 h-5"></i>
                                <span class="sr-only">${t('settings')}</span>
                            </button>
                            
                            <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
                            <button type="button" data-action="logout" class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span class="sr-only">${t('logout')}</span>
                            </button>
                        </div>
                    </div>
                </nav>
            `;
        }

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ¬Ø± (Storefront View) ---
        function renderStorefrontView() {
            const { products, isLoading } = AppState.state;
            
            return `
                <div class="flex flex-col min-h-screen">
                    ${renderNavbar()}
                    
                    <main class="flex-grow p-4 md:p-8 max-w-screen-xl mx-auto w-full">
                        <h1 class="text-3xl font-bold dark:text-white mb-6">${t('products')}</h1>
                        
                        ${isLoading && products.length === 0 ? `
                            <div class="text-center py-10">${t('loading')}</div>
                        ` : ''}

                        ${!isLoading && products.length === 0 ? `
                            <div class="text-center py-10 text-gray-500 dark:text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
                        ` : ''}
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${products.map(product => `
                                <div class="product-card">
                                    <div class="relative w-full h-48">
                                        <img src="${product.image_url || 'https://placehold.co/400x300/1e293b/94a3b8?text=No+Image'}" alt="${product.name}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="p-4">
                                        <h3 class="text-lg font-semibold dark:text-white">${product.name}</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate" title="${product.description}">${product.description}</p>
                                        <div class="flex items-center justify-between mt-4">
                                            <span class="text-xl font-bold text-primary-500">${t('sh')}${product.price}</span>
                                            <button 
                                                data-action="add-to-cart" 
                                                data-id="${product.id}" 
                                                class="btn-primary px-3 py-1.5"
                                                ${product.stock <= 0 ? 'disabled' : ''}>
                                                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </main>
                    
                    ${AppState.state.currentModal === 'cart' ? renderCartModal() : ''}
                </div>
            `;
        }
        
        // --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ù„Ø© (Cart Modal) ---
        function renderCartModal() {
            const { cart } = AppState.state;
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            return `
                <div class="modal-backdrop" data-action="close-modal"></div>
                <div class="modal-content">
                    <div class="modal-box">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold dark:text-white">${t('myCart')}</h3>
                            <button data-action="close-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        ${cart.length === 0 ? `
                            <p class="text-center text-gray-500 dark:text-gray-400 py-10">${t('emptyCart')}</p>
                        ` : `
                            <div class="space-y-4 max-h-[50vh] overflow-y-auto p-1">
                                ${cart.map(item => `
                                    <div class="flex items-center space-x-4 rtl:space-x-reverse">
                                        <img src="${item.imageUrl || 'https://placehold.co/100x100'}" alt="${item.name}" class="w-16 h-16 rounded-lg object-cover">
                                        <div class="flex-grow">
                                            <h4 class="font-medium dark:text-white">${item.name}</h4>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">${t('sh')}${item.price}</p>
                                        </div>
                                        <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                            <input 
                                                type="number" 
                                                min="1" 
                                                value="${item.quantity}" 
                                                class="input-field w-16 text-center"
                                                data-action="update-cart-quantity"
                                                data-id="${item.productId}">
                                            <button data-action="remove-from-cart" data-id="${item.productId}" class="text-red-500 hover:text-red-700 p-1">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="border-t dark:border-gray-700 mt-6 pt-4">
                                <div class="flex justify-between items-center text-lg font-semibold">
                                    <span class="dark:text-gray-300">${t('total')}:</span>
                                    <span class="text-primary-500">${t('sh')}${total.toFixed(2)}</span>
                                </div>
                                <button data-action="checkout" class="btn-primary w-full mt-4">
                                    ${t('checkout')}
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Admin View) ---
        function renderAdminView() {
            const { products, isLoading } = AppState.state;
            
            return `
                <div class="flex flex-col min-h-screen">
                    ${renderNavbar()}
                    
                    <main class="flex-grow p-4 md:p-8 max-w-screen-xl mx-auto w-full">
                        <div class="flex items-center justify-between mb-6">
                            <h1 class="text-3xl font-bold dark:text-white">${t('manageProducts')}</h1>
                            <button data-action="open-add-product-modal" class="btn-primary flex items-center space-x-2 rtl:space-x-reverse">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span>${t('addNewProduct')}</span>
                            </button>
                        </div>
                        
                        ${isLoading && products.length === 0 ? `
                            <div class="text-center py-10">${t('loading')}</div>
                        ` : ''}
                        
                        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
                        <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-x-auto">
                            <table class="w-full min-w-max text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">${t('productName')}</th>
                                        <th scope="col" class="px-6 py-3">${t('price')}</th>
                                        <th scope="col" class="px-6 py-3">${t('stock')}</th>
                                        <th scope="col" class="px-6 py-3 text-end">${t('actions')}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(product => `
                                        <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                                <div class="flex items-center space-x-3 rtl:space-x-reverse">
                                                    <img src="${product.image_url || 'https://placehold.co/40x40'}" alt="${product.name}" class="w-10 h-10 rounded-md object-cover">
                                                    <span>${product.name}</span>
                                                </div>
                                            </th>
                                            <td class="px-6 py-4">${t('sh')}${product.price}</td>
                                            <td class="px-6 py-4">${product.stock}</td>
                                            <td class="px-6 py-4 text-end">
                                                <div class="flex justify-end space-x-2 rtl:space-x-reverse">
                                                    <button data-action="open-edit-product-modal" data-id="${product.id}" class="text-primary-500 hover:text-primary-700 p-1">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button data-action="delete-product" data-id="${product.id}" class="text-red-500 hover:text-red-700 p-1">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${!isLoading && products.length === 0 ? `
                                <p class="text-center text-gray-500 dark:text-gray-400 py-10">Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</p>
                            ` : ''}
                        </div>
                    </main>
                    
                    ${AppState.state.currentModal === 'editProduct' ? renderProductFormModal() : ''}
                </div>
            `;
        }
        
        // --- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ---
        function renderProductFormModal() {
            const { productToEdit } = AppState.state;
            const isEditing = !!productToEdit;
            
            return `
                <div class="modal-backdrop" data-action="close-modal"></div>
                <div class="modal-content">
                    <form id="product-form" class="modal-box">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold dark:text-white">
                                ${isEditing ? t('editProduct') : t('addNewProduct')}
                            </h3>
                            <button type="button" data-action="close-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        
                        ${renderErrorMessage()}
                        
                        <input type="hidden" name="image_url" id="image_url" value="${productToEdit?.image_url || ''}">
                        
                        <div class="space-y-4">
                            <div>
                                <label for="name" class="block mb-2 text-sm font-medium">${t('productName')}</label>
                                <input type="text" name="name" id="name" class="input-field" value="${productToEdit?.name || ''}" required>
                            </div>
                            
                            <div>
                                <label for="description" class="block mb-2 text-sm font-medium">${t('productDescription')}</label>
                                <textarea name="description" id="description" rows="3" class="input-field">${productToEdit?.description || ''}</textarea>
                                <button type="button" data-action="generate-description" class="text-xs btn-secondary px-2 py-1 mt-1 flex items-center space-x-1 rtl:space-x-reverse">
                                    <i data-lucide="sparkles" class="w-3 h-3"></i>
                                    <span>${t('generateDescription')}</span>
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="price" class="block mb-2 text-sm font-medium">${t('productPrice')}</label>
                                    <input type="number" name="price" id="price" step="0.01" class="input-field" value="${productToEdit?.price || 0}" required>
                                </div>
                                <div>
                                    <label for="stock" class="block mb-2 text-sm font-medium">${t('productStock')}</label>
                                    <input type="number" name="stock" id="stock" class="input-field" value="${productToEdit?.stock || 0}" required>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-2 text-sm font-medium">${t('productImage')}</label>
                                <button type="button" data-action="upload-image" class="btn-secondary w-full flex items-center justify-center space-x-2 rtl:space-x-reverse">
                                    <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                                    <span>${t('uploadImage')}</span>
                                </button>
                                <img id="image-preview" src="${productToEdit?.image_url || ''}" class="${productToEdit?.image_url ? 'block' : 'hidden'} w-24 h-24 rounded-lg object-cover mt-2">
                            </div>

                        </div>
                        
                        <div class="border-t dark:border-gray-700 mt-6 pt-4 flex justify-end">
                            <button type="submit" data-action="save-product" class="btn-primary">
                                ${AppState.state.isLoading ? t('loading') : t('save')}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // --- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù… ---
        function renderWhatsappButton() {
            const { whatsappNumber } = AppState.state.settings.apiKeys;
            if (!whatsappNumber || AppState.state.currentView === 'login' || AppState.state.currentView === 'settings') {
                document.getElementById('whatsapp-button-container').innerHTML = '';
                return;
            }
            
            const message = encodeURIComponent(t('contactSupport'));
            const waLink = `https://wa.me/${whatsappNumber.replace(/\+/g, '')}?text=${message}`;
            
            document.getElementById('whatsapp-button-container').innerHTML = `
                <a href="${waLink}" target="_blank" rel="noopener noreferrer" 
                   class="fixed bottom-6 end-6 z-30 bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition-transform hover:scale-110">
                   <i data-lucide="message-circle" class="w-6 h-6" style="fill: white;"></i>
                   <span class="sr-only">${t('contactSupport')}</span>
                </a>
            `;
        }


        // --- 6. Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Renderer) ---
        
        const root = document.getElementById('app-root');

        function renderApp() {
            // 1. ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø«ÙŠÙ…)
            const { lang, theme } = AppState.state.settings;
            document.documentElement.lang = lang;
            document.documentElement.dir = ['ar', 'he'].includes(lang) ? 'rtl' : 'ltr';
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯)
            document.body.className.split(' ').forEach(cls => {
                if (cls.startsWith('theme-')) {
                    document.body.classList.remove(cls);
                }
            });
            document.body.classList.add(theme);
            
            // 2. Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const { currentView, isLoading } = AppState.state;
            
            if (currentView === 'loading' || (isLoading && !AppState.state.user && currentView !== 'settings')) {
                root.innerHTML = renderLoading();
            } else if (currentView === 'login') {
                root.innerHTML = renderLoginView();
            } else if (currentView === 'settings') {
                root.innerHTML = renderSettingsView();
            } else if (currentView === 'store') {
                root.innerHTML = renderStorefrontView();
            } else if (currentView === 'admin') {
                root.innerHTML = renderAdminView();
            } else {
                // Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (fallback)
                root.innerHTML = renderLoginView();
            }
            
            // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© (ÙˆØ§ØªØ³Ø§Ø¨)
            renderWhatsappButton();

            // 4. ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            // (Ù…Ù‡Ù…: ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ DOM)
            lucide.createIcons();
        }


        // --- 7. Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Handlers) ---
        
        function attachGlobalListeners() {
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Event Delegation)
            document.body.addEventListener('submit', async (e) => {
                e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                const formId = e.target.id;
                
                if (formId === 'login-form') {
                    const formData = new FormData(e.target);
                    const email = formData.get('email');
                    const password = formData.get('password');
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡
                    const action = e.submitter?.dataset.action;
                    if (action === 'login-submit') {
                        handleLogin(email, password);
                    } else if (action === 'signup-submit') {
                        handleSignup(email, password);
                    }
                }
                
                if (formId === 'settings-form') {
                    const formData = new FormData(e.target);
                    const newSettings = {
                        lang: formData.get('lang'),
                        theme: formData.get('theme'),
                        apiKeys: {
                            supabaseUrl: formData.get('supabaseUrl'),
                            supabaseKey: formData.get('supabaseKey'),
                            cloudinaryCloudName: formData.get('cloudinaryCloudName'),
                            cloudinaryUploadPreset: formData.get('cloudinaryUploadPreset'),
                            openRouterKey: formData.get('openRouterKey'),
                            whatsappNumber: formData.get('whatsappNumber')
                        }
                    };
                    // Ø§Ù…Ø³Ø­ Ø£ÙŠ Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
                    AppState.setState({ settings: newSettings, errorMessage: null });
                    saveSettings();
                }
                
                if (formId === 'product-form') {
                    const formData = new FormData(e.target);
                    const productData = {
                        name: formData.get('name'),
                        description: formData.get('description'),
                        price: parseFloat(formData.get('price')),
                        stock: parseInt(formData.get('stock')),
                        image_url: formData.get('image_url')
                    };
                    
                    if (AppState.state.productToEdit) {
                        // ØªØ­Ø¯ÙŠØ«
                        updateProduct(AppState.state.productToEdit.id, productData);
                    } else {
                        // Ø¥Ø¶Ø§ÙØ©
                        addProduct(productData);
                    }
                }
            });

            // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø±Ø§Øª
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;
                const id = target.dataset.id;
                
                switch (action) {
                    case 'go-to-settings':
                        AppState.setState({ currentView: 'settings', errorMessage: null });
                        break;
                    
                    case 'back-from-settings':
                        // Ø§Ù…Ø³Ø­ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                        AppState.setState({ errorMessage: null });

                        // Ø­Ø§ÙˆÙ„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
                        if (initServices()) {
                            // Ù†Ø¬Ø­: Ø§Ø°Ù‡Ø¨ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© (Ù…ØªØ¬Ø±/Ù…Ø¯ÙŠØ±)
                            const nextView = AppState.state.user ? (AppState.state.user.role === 'admin' ? 'admin' : 'store') : 'login';
                            AppState.setState({ currentView: nextView });
                        } else {
                            // ÙØ´Ù„ (Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù„Ø§ ØªØ²Ø§Ù„ Ù…ÙÙ‚ÙˆØ¯Ø©): Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                            AppState.setState({ currentView: 'login' }); 
                        }
                        break;

                    case 'logout':
                        handleLogout();
                        break;
                    case 'go-to-home':
                    case 'go-to-store':
                        AppState.setState({ currentView: 'store' });
                        break;
                    case 'go-to-admin':
                        AppState.setState({ currentView: 'admin' });
                        break;
                    
                    // --- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ù…ØªØ¬Ø± ---
                    case 'open-cart':
                        AppState.setState({ currentModal: 'cart' });
                        break;
                    case 'close-modal':
                        AppState.setState({ currentModal: null, productToEdit: null, errorMessage: null });
                        break;
                    case 'add-to-cart':
                        addToCart(parseInt(id));
                        break;
                    case 'remove-from-cart':
                        removeFromCart(parseInt(id));
                        break;
                    case 'checkout':
                        // (Ù‡Ù†Ø§ ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ØŒ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø³Ù†Ù‚ÙˆÙ… ÙÙ‚Ø· Ø¨ØªÙ†Ø¨ÙŠÙ‡)
                        showToast('Checkout process is not implemented.', 'info');
                        break;
                    
                    // --- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¯ÙŠØ± ---
                    case 'open-add-product-modal':
                        AppState.setState({ currentModal: 'editProduct', productToEdit: null });
                        break;
                    case 'open-edit-product-modal':
                        const product = AppState.state.products.find(p => p.id === parseInt(id));
                        if (product) {
                            AppState.setState({ currentModal: 'editProduct', productToEdit: product });
                        }
                        break;
                    case 'delete-product':
                        deleteProduct(parseInt(id));
                        break;
                    case 'upload-image':
                        openCloudinaryWidget((imageUrl) => {
                            // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ†ØªÙ‡Ø§
                            const urlInput = document.getElementById('image_url');
                            const previewImg = document.getElementById('image-preview');
                            if (urlInput && previewImg) {
                                urlInput.value = imageUrl;
                                previewImg.src = imageUrl;
                                previewImg.classList.remove('hidden');
                            }
                        });
                        break;
                    case 'generate-description':
                        const nameInput = document.getElementById('name');
                        const descInput = document.getElementById('description');
                        if (nameInput && descInput && nameInput.value) {
                            target.disabled = true;
                            target.innerHTML = t('generating');
                            const description = await generateAIProductDescription(nameInput.value);
                            if (description) {
                                descInput.value = description;
                            }
                            target.disabled = false;
                            target.innerHTML = `<i data-lucide="sparkles" class="w-3 h-3"></i> <span>${t('generateDescription')}</span>`;
                            lucide.createIcons(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                        } else {
                            showToast(t('productName') + ' is required.', 'error');
                        }
                        break;
                }
            });
            
            // Ù…Ø¹Ø§Ù„Ø¬ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ø³Ù„Ø©)
            document.body.addEventListener('change', (e) => {
                const target = e.target.closest('[data-action="update-cart-quantity"]');
                if (target) {
                    const id = parseInt(target.dataset.id);
                    const quantity = parseInt(target.value);
                    updateCartQuantity(id, quantity);
                }
            });
        }


        // --- 8. Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Entry Point) ---
        
        function main() {
            // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¹Ø±Ø¶
            AppState.addListener(renderApp);
            
            // 2. Ø¥Ø±ÙØ§Ù‚ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            attachGlobalListeners();
            
            // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† localStorage
            loadSettings();

            // 4. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Supabase)
            // Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©ØŒ
            // Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ 'settings' (Ù„Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© 'loading')
            // ÙˆÙ„ÙƒÙ†Ù‡ Ù„Ù† ÙŠØ¹ÙŠÙ‘Ù† Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£.
            initServices();
            
            // 5. Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
            // Ø³ÙŠØ¹Ø±Ø¶ 'settings' (Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ø²Ø±Ù‚) Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…ÙÙ‚ÙˆØ¯Ø©.
            // Ø£Ùˆ Ø³ÙŠØ¹Ø±Ø¶ 'login' / 'store' / 'admin' Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©.
            renderApp();
        }

        // ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        main();

    </script>
</body>
</html>

